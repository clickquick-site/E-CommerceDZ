<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</title>
  <link rel="stylesheet" href="style.css">
</head>
<body style="margin:0;background:var(--bg);height:100vh;overflow:hidden;display:flex;flex-direction:column">

<div class="page-body" style="flex:1;overflow-y:auto;padding:16px 20px" id="users-root">

  <div id="users-content">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

</div>

<!-- Add User Modal -->
<div class="modal-overlay" id="add-user-modal">
  <div class="modal">
    <div class="modal-header">
      <h3>â• Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
      <button class="modal-close" onclick="closeM('add-user-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input id="nu-name" type="text"></div>
      <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input id="nu-user" type="text"></div>
      <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="nu-pass" type="password"></div>
      <div class="form-group">
        <label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
        <select id="nu-role">
          <option value="manager">Ù…Ø¯ÙŠØ± Ù…Ø³Ø§Ø¹Ø¯ (ÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª)</option>
          <option value="seller">Ø¨Ø§Ø¦Ø¹ (Ø¨ÙŠØ¹ ÙÙ‚Ø·)</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeM('add-user-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="saveNewUser()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<script>
const DB = window.parent.DB;
const getState = () => window.parent.State;
const showToast = (msg, type, dur) => window.parent.showToast(msg, type, dur);

window.addEventListener('load', () => renderPage());

function closeM(id) { document.getElementById(id).classList.remove('open'); }

function renderPage() {
  const State = getState();
  if (!State) return;
  const isAdmin = State.currentUser?.role === 'admin';
  const content = document.getElementById('users-content');

  if (!isAdmin) {
    content.innerHTML = '<div class="notif-item danger">â›” Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·</div>';
    return;
  }

  content.innerHTML = `
    <div style="display:flex;justify-content:flex-end;margin-bottom:12px">
      <button class="btn btn-primary btn-sm" onclick="showAddUserModal()">â• Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</button>
    </div>
    <div class="data-table-wrap">
      <table class="data-table">
        <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
        <tbody id="users-tbody"></tbody>
      </table>
    </div>
  `;
  renderUsersTable();
}

function renderUsersTable() {
  const State = getState();
  if (!State) return;
  const tbody = document.getElementById('users-tbody');
  if (!tbody) return;
  const roles = { admin: 'ğŸ”´ Ù…Ø¯ÙŠØ±', manager: 'ğŸŸ¡ Ù…Ø¯ÙŠØ± Ù…Ø³Ø§Ø¹Ø¯', seller: 'ğŸŸ¢ Ø¨Ø§Ø¦Ø¹' };
  tbody.innerHTML = State.users.map(u => `
    <tr>
      <td>${u.name}</td>
      <td>${u.username}</td>
      <td>${roles[u.role] || u.role}</td>
      <td>
        ${u.role !== 'admin' ? `<button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">ğŸ—‘</button>` : ''}
        <button class="btn btn-sm btn-outline" onclick="editUserPass(${u.id})">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
      </td>
    </tr>
  `).join('');
}

function showAddUserModal() { document.getElementById('add-user-modal').classList.add('open'); }

function saveNewUser() {
  const State = getState();
  const name = document.getElementById('nu-name').value.trim();
  const username = document.getElementById('nu-user').value.trim();
  const password = document.getElementById('nu-pass').value;
  const role = document.getElementById('nu-role').value;
  if (!name || !username || !password) { showToast('âš ï¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©', 'error'); return; }
  if (State.users.find(u => u.username === username)) { showToast('âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'error'); return; }
  State.users.push({ id: Date.now(), name, username, password, role });
  DB.set('users', State.users);
  closeM('add-user-modal');
  document.getElementById('nu-name').value = '';
  document.getElementById('nu-user').value = '';
  document.getElementById('nu-pass').value = '';
  renderUsersTable();
  showToast(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ©: ${name}`, 'success');
}

function deleteUser(id) {
  if (!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
  const State = getState();
  State.users = State.users.filter(u => u.id !== id);
  DB.set('users', State.users);
  renderUsersTable();
}

function editUserPass(id) {
  const State = getState();
  const u = State.users.find(x => x.id === id);
  if (!u) return;
  const pass = prompt(`ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù€ ${u.name}:`);
  if (!pass) return;
  u.password = pass;
  DB.set('users', State.users);
  showToast('âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'success');
}
</script>
</body>
</html>
