<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©</title>
  <link rel="stylesheet" href="style.css">
</head>
<body style="margin:0;background:var(--bg);height:100vh;overflow:hidden;display:flex;flex-direction:column">

<div class="page-body" style="flex:1;overflow-y:auto;padding:16px 20px">

  <div class="cards-row" id="ext-stats"></div>

  <div style="display:flex;justify-content:flex-end;margin-bottom:12px">
    <button class="btn btn-primary btn-sm" onclick="showAddExtDebtModal()">â• Ø¯ÙŠÙ† Ø¬Ø¯ÙŠØ¯</button>
  </div>

  <div class="data-table-wrap">
    <table class="data-table">
      <thead><tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙŠÙ†</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr></thead>
      <tbody id="ext-debts-tbody"></tbody>
    </table>
  </div>

</div>

<!-- Add External Debt Modal -->
<div class="modal-overlay" id="add-ext-debt-modal">
  <div class="modal">
    <div class="modal-header">
      <h3>â• Ø¯ÙŠÙ† Ø®Ø§Ø±Ø¬ÙŠ Ø¬Ø¯ÙŠØ¯</h3>
      <button class="modal-close" onclick="closeM('add-ext-debt-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù… *</label><input id="ed-name" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ø£Ùˆ Ø§Ù„Ø´Ø®Øµ"></div>
      <div class="form-group"><label>Ø§Ù„Ù‡Ø§ØªÙ *</label><input id="ed-phone" type="tel" placeholder="0xxxxxxxx"></div>
      <div class="form-group"><label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙŠÙ† *</label><input id="ed-amount" type="number" min="0" placeholder="0"></div>
      <div class="form-group"><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><textarea id="ed-note" rows="2" placeholder="ÙˆØµÙ Ø§Ù„Ø¯ÙŠÙ†..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeM('add-ext-debt-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="saveExtDebt()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<script>
const DB = window.parent.DB;
const getState = () => window.parent.State;
const showToast = (msg, type, dur) => window.parent.showToast(msg, type, dur);

window.addEventListener('load', () => {
  renderExtStats();
  renderExtDebtsTable();
});

function closeM(id) { document.getElementById(id).classList.remove('open'); }
function showAddExtDebtModal() { document.getElementById('add-ext-debt-modal').classList.add('open'); }

function renderExtStats() {
  const State = getState();
  if (!State) return;
  const total = State.externalDebts.reduce((s,d) => s + (d.remaining||0), 0);
  document.getElementById('ext-stats').innerHTML = `
    <div class="stat-card">
      <div class="sc-accent" style="background:var(--danger)"></div>
      <div class="sc-icon">ğŸ’¸</div>
      <div class="sc-value">${total.toFixed(2)} ${State.settings.currency}</div>
      <div class="sc-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©</div>
    </div>
    <div class="stat-card">
      <div class="sc-accent" style="background:var(--warning)"></div>
      <div class="sc-icon">ğŸ“‹</div>
      <div class="sc-value">${State.externalDebts.filter(d => (d.remaining||0) > 0).length}</div>
      <div class="sc-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù†Ø´Ø·Ø©</div>
    </div>
  `;
}

function renderExtDebtsTable() {
  const State = getState();
  if (!State) return;
  const tbody = document.getElementById('ext-debts-tbody');
  if (!tbody) return;
  tbody.innerHTML = State.externalDebts.length ? State.externalDebts.map(d => `
    <tr>
      <td><strong>${d.name}</strong>${d.note ? `<br><small style="color:var(--text-muted)">${d.note}</small>` : ''}</td>
      <td>${d.phone}</td>
      <td>${d.amount.toFixed(2)} ${State.settings.currency}</td>
      <td>${(d.paid||0).toFixed(2)} ${State.settings.currency}</td>
      <td><span class="badge ${(d.remaining||0)<=0?'badge-success':'badge-danger'}">${(d.remaining||d.amount).toFixed(2)} ${State.settings.currency}</span></td>
      <td>
        ${(d.remaining||d.amount) > 0 ? `<button class="btn btn-sm btn-warning" onclick="partialExtPay('${d.id}')">ğŸ’° ØªØ³Ø¯ÙŠØ¯</button>` : '<span style="color:var(--success)">âœ… Ù…Ø³Ø¯Ø¯</span>'}
        <button class="btn btn-sm btn-danger" onclick="deleteExtDebt('${d.id}')">ğŸ—‘</button>
      </td>
    </tr>
  `).join('') : '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ø®Ø§Ø±Ø¬ÙŠØ©</td></tr>';
}

function saveExtDebt() {
  const State = getState();
  const name = document.getElementById('ed-name').value.trim();
  const phone = document.getElementById('ed-phone').value.trim();
  const amount = parseFloat(document.getElementById('ed-amount').value) || 0;
  const note = document.getElementById('ed-note').value;
  if (!name || !phone || !amount) { showToast('âš ï¸ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©', 'error'); return; }
  State.externalDebts.push({ id: Date.now().toString(), name, phone, amount, paid: 0, remaining: amount, note, date: new Date().toISOString() });
  DB.set('external_debts', State.externalDebts);
  closeM('add-ext-debt-modal');
  document.getElementById('ed-name').value = '';
  document.getElementById('ed-phone').value = '';
  document.getElementById('ed-amount').value = '';
  document.getElementById('ed-note').value = '';
  renderExtStats();
  renderExtDebtsTable();
  showToast(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ†: ${name}`, 'success');
}

function partialExtPay(id) {
  const State = getState();
  const d = State.externalDebts.find(x => x.id === id);
  if (!d) return;
  const amount = parseFloat(prompt(`ØªØ³Ø¯ÙŠØ¯ - Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${(d.remaining||d.amount).toFixed(2)}\nØ£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº:`));
  if (!amount || amount <= 0) return;
  d.paid = (d.paid || 0) + Math.min(amount, d.remaining || d.amount);
  d.remaining = d.amount - d.paid;
  DB.set('external_debts', State.externalDebts);
  renderExtStats();
  renderExtDebtsTable();
  showToast('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ³Ø¯ÙŠØ¯', 'success');
}

function deleteExtDebt(id) {
  if (!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙŠÙ†ØŸ')) return;
  const State = getState();
  State.externalDebts = State.externalDebts.filter(d => d.id !== id);
  DB.set('external_debts', State.externalDebts);
  renderExtStats();
  renderExtDebtsTable();
}
</script>
</body>
</html>
