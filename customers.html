<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</title>
  <link rel="stylesheet" href="style.css">
</head>
<body style="margin:0;background:var(--bg);height:100vh;overflow:hidden;display:flex;flex-direction:column">

<div class="page-body" style="flex:1;overflow-y:auto;padding:16px 20px">

  <div style="display:flex;justify-content:flex-end;margin-bottom:12px">
    <button class="btn btn-primary btn-sm" onclick="showAddCustomerModal()">â• Ø²Ø¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯</button>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchCustTab('customers',this)">ğŸ‘¤ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ÙˆØ§Ù„Ø¯ÙŠÙˆÙ†</button>
    <button class="tab-btn" onclick="switchCustTab('deliveries',this)">ğŸšš Ø§Ù„ØªÙˆØµÙŠÙ„</button>
  </div>

  <!-- Customers Tab -->
  <div id="cust-tab-customers">
    <div class="search-box">
      <span class="search-icon">ğŸ”</span>
      <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø²Ø¨ÙˆÙ†..." oninput="searchCustomers(this.value)">
    </div>
    <div class="data-table-wrap">
      <table class="data-table">
        <thead><tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¯ÙŠÙ†</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙŠÙ†</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr></thead>
        <tbody id="customers-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Deliveries Tab -->
  <div id="cust-tab-deliveries" style="display:none">
    <div class="data-table-wrap">
      <table class="data-table">
        <thead><tr>
          <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„Ø²Ø¨ÙˆÙ†</th><th>Ø§Ù„Ø´Ø±ÙƒØ©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr></thead>
        <tbody id="deliveries-tbody"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- Add Customer Modal -->
<div class="modal-overlay" id="add-cust-modal">
  <div class="modal">
    <div class="modal-header">
      <h3>â• Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯</h3>
      <button class="modal-close" onclick="closeM('add-cust-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù… *</label><input type="text" id="new-cust-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†"></div>
      <div class="form-group"><label>Ø§Ù„Ù‡Ø§ØªÙ *</label><input type="tel" id="new-cust-phone" placeholder="0xxxxxxxx"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeM('add-cust-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="saveNewCustomer()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<script>
const DB = window.parent.DB;
const getState = () => window.parent.State;
const showToast = (msg, type, dur) => window.parent.showToast(msg, type, dur);

window.addEventListener('load', () => {
  renderCustomersTable();
  renderDeliveriesTable();
});

function closeM(id) { document.getElementById(id).classList.remove('open'); }
function showAddCustomerModal() { document.getElementById('add-cust-modal').classList.add('open'); }

function switchCustTab(tab, btn) {
  document.querySelectorAll('.tabs .tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('cust-tab-customers').style.display = tab === 'customers' ? 'block' : 'none';
  document.getElementById('cust-tab-deliveries').style.display = tab === 'deliveries' ? 'block' : 'none';
}

function saveNewCustomer() {
  const State = getState();
  const name = document.getElementById('new-cust-name').value.trim();
  const phone = document.getElementById('new-cust-phone').value.trim();
  if (!name || !phone) { showToast('âš ï¸ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†', 'error'); return; }
  State.customers.push({ id: Date.now(), name, phone, debt: 0, debtDate: null });
  DB.set('customers', State.customers);
  closeM('add-cust-modal');
  document.getElementById('new-cust-name').value = '';
  document.getElementById('new-cust-phone').value = '';
  renderCustomersTable();
  showToast(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ©: ${name}`, 'success');
}

function renderCustomersTable(filter = '') {
  const State = getState();
  if (!State) return;
  const tbody = document.getElementById('customers-tbody');
  if (!tbody) return;
  const list = filter
    ? State.customers.filter(c => c.name.includes(filter) || c.phone.includes(filter))
    : State.customers;
  tbody.innerHTML = list.length ? list.map(c => `
    <tr>
      <td><strong>${c.name}</strong></td>
      <td>${c.phone}</td>
      <td><span class="badge ${c.debt > 0 ? 'badge-danger' : 'badge-success'}">${(c.debt||0).toFixed(2)} ${State.settings.currency}</span></td>
      <td>${c.debtDate ? new Date(c.debtDate).toLocaleDateString('ar-DZ') : '-'}</td>
      <td>
        ${c.debt > 0 ? `
          <button class="btn btn-sm btn-success" onclick="payDebt(${c.id})">âœ… ØªØ³Ø¯ÙŠØ¯</button>
          <button class="btn btn-sm btn-warning" onclick="partialPayDebt(${c.id})">ğŸ’° Ø¬Ø²Ø¦ÙŠ</button>
        ` : ''}
        <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${c.id})">ğŸ—‘</button>
      </td>
    </tr>
  `).join('') : '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text-muted)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø¨Ø§Ø¦Ù†</td></tr>';
}

function searchCustomers(val) { renderCustomersTable(val); }

function payDebt(custId) {
  const State = getState();
  const c = State.customers.find(x => x.id === custId);
  if (!c) return;
  const sale = { id: Date.now(), invoiceNum: '#DEBT', type: 'debt_payment', customerName: c.name, total: c.debt, date: new Date().toISOString() };
  State.sales.push(sale); State.todaySales.push(sale);
  DB.set('sales', State.sales); DB.set('today_sales', State.todaySales);
  c.debt = 0; c.debtDate = null;
  DB.set('customers', State.customers);
  renderCustomersTable();
  showToast(`âœ… ØªÙ… ØªØ³Ø¯ÙŠØ¯ Ø¯ÙŠÙ†: ${c.name}`, 'success');
}

function partialPayDebt(custId) {
  const State = getState();
  const c = State.customers.find(x => x.id === custId);
  if (!c) return;
  const amount = parseFloat(prompt(`ØªØ³Ø¯ÙŠØ¯ Ø¬Ø²Ø¦ÙŠ Ù„Ù€ ${c.name}\nØ§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${c.debt}\nØ£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº:`));
  if (!amount || amount <= 0) return;
  const paid = Math.min(amount, c.debt);
  c.debt -= paid;
  const sale = { id: Date.now(), invoiceNum: '#PARTIAL', type: 'partial_payment', customerName: c.name, total: paid, date: new Date().toISOString() };
  State.sales.push(sale); State.todaySales.push(sale);
  DB.set('sales', State.sales); DB.set('today_sales', State.todaySales);
  DB.set('customers', State.customers);
  renderCustomersTable();
  showToast(`âœ… ØªÙ… ØªØ³Ø¯ÙŠØ¯ ${paid} ${State.settings.currency}`, 'success');
}

function deleteCustomer(custId) {
  if (!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ†ØŸ')) return;
  const State = getState();
  State.customers = State.customers.filter(c => c.id !== custId);
  DB.set('customers', State.customers);
  renderCustomersTable();
  showToast('ğŸ—‘ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø²Ø¨ÙˆÙ†', 'info');
}

function renderDeliveriesTable() {
  const State = getState();
  if (!State) return;
  const tbody = document.getElementById('deliveries-tbody');
  if (!tbody) return;
  const companies = { world_express:'World Express',yalidine:'Yalidine',dhd:'DHD Livraison',kazi:'Kazi Tour',zr:'ZR Express' };
  tbody.innerHTML = State.deliveries.length ? State.deliveries.map(d => `
    <tr>
      <td>${d.invoiceNum}</td>
      <td>${d.customerName}</td>
      <td>${companies[d.company] || d.company || '-'}</td>
      <td>${d.total} ${State.settings.currency}</td>
      <td><span class="badge ${d.status==='paid'?'badge-success':'badge-warning'}">${d.status==='paid'?'Ù…Ø³Ø¯Ø¯':'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„'}</span></td>
      <td>
        ${d.status !== 'paid' ? `<button class="btn btn-sm btn-success" onclick="payDelivery('${d.id}')">âœ… ØªØ³Ø¯ÙŠØ¯</button>` : ''}
        <button class="btn btn-sm btn-danger" onclick="deleteDelivery('${d.id}')">ğŸ—‘</button>
      </td>
    </tr>
  `).join('') : '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØµÙŠÙ„Ø§Øª</td></tr>';
}

function payDelivery(id) {
  const State = getState();
  const d = State.deliveries.find(x => x.id == id);
  if (!d) return;
  d.status = 'paid';
  const sale = { id: Date.now(), invoiceNum: d.invoiceNum, type: 'delivery_paid', total: d.total, date: new Date().toISOString() };
  State.sales.push(sale); State.todaySales.push(sale);
  DB.set('sales', State.sales); DB.set('today_sales', State.todaySales);
  DB.set('deliveries', State.deliveries);
  renderDeliveriesTable();
  showToast('âœ… ØªÙ… ØªØ³Ø¯ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„', 'success');
}

function deleteDelivery(id) {
  if (!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙˆØµÙŠÙ„ØŸ')) return;
  const State = getState();
  State.deliveries = State.deliveries.filter(d => d.id != id);
  DB.set('deliveries', State.deliveries);
  renderDeliveriesTable();
}
</script>
</body>
</html>
