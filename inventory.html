<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø¹</title>
  <link rel="stylesheet" href="style.css">
</head>
<body style="margin:0;background:var(--bg);height:100vh;overflow:hidden;display:flex;flex-direction:column">

<div class="page-body" style="flex:1;overflow-y:auto;padding:16px 20px" id="inv-root">

  <!-- Notifications -->
  <div class="notif-box" id="inv-notif">
    <span style="color:var(--text-muted)">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchInvTab('all',this)">ğŸ“‹ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
    <button class="tab-btn" onclick="switchInvTab('add',this)">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
  </div>

  <!-- All Products Tab -->
  <div id="inv-tab-all">
    <div class="search-box">
      <span class="search-icon">ğŸ”</span>
      <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." oninput="searchProducts(this.value)" id="product-search">
    </div>
    <div class="data-table-wrap">
      <table class="data-table" id="products-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ù„Ù†ÙˆØ¹</th>
            <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
            <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="products-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Add Product Tab -->
  <div id="inv-tab-add" style="display:none">
    <div class="notif-box" id="add-prod-notif" style="margin-bottom:14px"></div>
    <div style="background:var(--bg-card);border-radius:var(--radius);padding:20px;border:1px solid var(--border)">
      <div class="form-row">
        <div class="form-group">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ *</label>
          <input type="text" id="prod-name" placeholder="Ù…Ø«Ø§Ù„: Ø­Ø°Ø§Ø¡ Ø±ÙŠØ§Ø¶ÙŠ">
        </div>
        <div class="form-group">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬</label>
          <input type="text" id="prod-type" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ø°ÙŠØ©">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Ø§Ù„ÙˆØ­Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <select id="prod-unit">
            <option value="">-- Ø§Ø®ØªØ± --</option>
            <option>Ù‚Ø·Ø¹Ø©</option><option>ÙƒÙŠÙ„Ùˆ</option><option>Ù„ØªØ±</option>
            <option>Ø¹Ù„Ø¨Ø©</option><option>Ø¯Ø³ØªØ©</option><option>Ø­Ø¨Ø©</option>
          </select>
        </div>
        <div class="form-group">
          <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ *</label>
          <input type="number" id="prod-buy" placeholder="0" min="0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ *</label>
          <input type="number" id="prod-sell" placeholder="0" min="0">
        </div>
        <div class="form-group">
          <label>Ø§Ù„ÙƒÙ…ÙŠØ© *</label>
          <input type="number" id="prod-qty" placeholder="0" min="0">
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:8px">
        <button class="btn btn-outline" onclick="clearProductForm()">ğŸ—‘ ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        <button class="btn btn-primary" onclick="saveProduct()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
      </div>
    </div>
  </div>

</div>

<script>
// ===== ACCESS PARENT STATE =====
const DB = window.parent.DB;
const getState = () => window.parent.State;

function showToast(msg, type = 'info', dur = 3000) {
  window.parent.showToast(msg, type, dur);
}

// ===== INIT =====
window.addEventListener('load', () => {
  renderStockNotifications();
  renderProductsTable();
});

// ===== NOTIFICATIONS =====
function renderStockNotifications() {
  const State = getState();
  if (!State) return;
  const low = State.products.filter(p => p.qty > 0 && p.qty <= 5);
  const zero = State.products.filter(p => p.qty <= 0);
  const box = document.getElementById('inv-notif');
  if (!low.length && !zero.length) {
    box.innerHTML = '<span style="color:var(--text-muted)">âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø®Ø²ÙˆÙ†</span>';
    return;
  }
  box.innerHTML = [
    ...zero.map(p => `<div class="notif-item danger">âŒ Ù†ÙØ§Ø¯ Ù…Ø®Ø²ÙˆÙ†: <strong>${p.name}</strong></div>`),
    ...low.map(p => `<div class="notif-item warning">âš ï¸ Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶: <strong>${p.name}</strong> (Ø¨Ù‚ÙŠ ${p.qty})</div>`)
  ].join('');
}

// ===== TABS =====
function switchInvTab(tab, btn) {
  document.querySelectorAll('.tabs .tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('inv-tab-all').style.display = tab === 'all' ? 'block' : 'none';
  document.getElementById('inv-tab-add').style.display = tab === 'add' ? 'block' : 'none';
}

// ===== TABLE =====
function renderProductsTable(filter = '') {
  const State = getState();
  if (!State) return;
  const tbody = document.getElementById('products-tbody');
  if (!tbody) return;
  const list = filter
    ? State.products.filter(p =>
        p.name.toLowerCase().includes(filter.toLowerCase()) ||
        (p.type || '').toLowerCase().includes(filter.toLowerCase()))
    : State.products;

  tbody.innerHTML = list.length ? list.map((p, i) => `
    <tr>
      <td>${i + 1}</td>
      <td><strong>${p.name}</strong></td>
      <td>${p.type || '-'}</td>
      <td>${p.buyPrice} ${State.settings.currency}</td>
      <td>${p.sellPrice} ${State.settings.currency}</td>
      <td>${p.qty}</td>
      <td>
        <span class="badge ${p.qty <= 0 ? 'badge-danger' : p.qty <= 5 ? 'badge-warning' : 'badge-success'}">
          ${p.qty <= 0 ? 'Ù†ÙØ¯' : p.qty <= 5 ? 'Ù…Ù†Ø®ÙØ¶' : 'Ù…ØªÙˆÙØ±'}
        </span>
      </td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="editProduct('${p.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.id}')">ğŸ—‘</button>
      </td>
    </tr>
  `).join('') : '<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--text-muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</td></tr>';
}

function searchProducts(val) { renderProductsTable(val); }

// ===== ADD PRODUCT =====
function saveProduct() {
  const State = getState();
  if (!State) return;
  const name = document.getElementById('prod-name').value.trim();
  const type = document.getElementById('prod-type').value.trim();
  const unit = document.getElementById('prod-unit').value;
  const buyPrice = parseFloat(document.getElementById('prod-buy').value) || 0;
  const sellPrice = parseFloat(document.getElementById('prod-sell').value) || 0;
  const qty = parseInt(document.getElementById('prod-qty').value) || 0;
  const notif = document.getElementById('add-prod-notif');

  if (!name) {
    if (notif) notif.innerHTML = '<div class="notif-item danger">âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</div>';
    return;
  }
  if (State.products.find(p => p.name.toLowerCase() === name.toLowerCase())) {
    if (notif) notif.innerHTML = `<div class="notif-item warning">âš ï¸ Ø§Ù„Ù…Ù†ØªØ¬ "${name}" Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹</div>`;
    return;
  }
  if (sellPrice < buyPrice) {
    if (notif) notif.innerHTML = `<div class="notif-item warning">âš ï¸ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø£Ù‚Ù„ Ù…Ù† Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡!</div>`;
  }

  const product = {
    id: Date.now().toString(), name, type, unit,
    buyPrice, sellPrice, qty,
    createdAt: new Date().toISOString()
  };
  State.products.push(product);
  DB.set('products', State.products);

  if (notif) notif.innerHTML = `<div class="notif-item info">âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬: <strong>${name}</strong></div>`;
  clearProductForm();
  renderProductsTable();
  renderStockNotifications();
  showToast(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ©: ${name}`, 'success');
}

function clearProductForm() {
  ['prod-name','prod-type','prod-buy','prod-sell','prod-qty'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  const u = document.getElementById('prod-unit'); if (u) u.value = '';
  const notif = document.getElementById('add-prod-notif');
  if (notif) notif.innerHTML = '';
}

// ===== EDIT / DELETE =====
function editProduct(id) {
  const State = getState();
  const p = State.products.find(x => x.id === id);
  if (!p) return;
  const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:', p.name);
  if (name === null) return;
  const buyPrice = parseFloat(prompt('Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:', p.buyPrice)) || p.buyPrice;
  const sellPrice = parseFloat(prompt('Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:', p.sellPrice)) || p.sellPrice;
  const qty = parseInt(prompt('Ø§Ù„ÙƒÙ…ÙŠØ©:', p.qty));
  if (isNaN(qty)) return;
  p.name = name || p.name;
  p.buyPrice = buyPrice;
  p.sellPrice = sellPrice;
  p.qty = qty;
  DB.set('products', State.products);
  renderProductsTable();
  renderStockNotifications();
  showToast('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬', 'success');
}

function deleteProduct(id) {
  if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;
  const State = getState();
  State.products = State.products.filter(p => p.id !== id);
  DB.set('products', State.products);
  renderProductsTable();
  renderStockNotifications();
  showToast('ğŸ—‘ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', 'info');
}
</script>
</body>
</html>
